-- Drop if exists
DROP TABLE IF EXISTS PR_DB_TEST.TRAFFIC;

-- Create + Description of columns
CREATE TABLE PR_DB_TEST.TRAFFIC (
    CLIENT VARCHAR(17) COMMENT 'Client MAC address',
    PROTOCOL VARCHAR(17) COMMENT 'Protocol name',
    TRAFFIC_IN INTEGER COMMENT 'Traffic In',
    TRAFFIC_OUT INTEGER COMMENT 'Traffic Out'
);

-- Inserts
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('19-58-33-40-6E-66', 'BGP', 233109, 974446);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('19-58-33-40-6E-66', 'DNS', 260151, 56050);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('19-58-33-40-6E-66', 'DNS', 808450, 78154);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('19-58-33-40-6E-66', 'POP', 626847, 432101);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('19-58-33-40-6E-66', 'SNP', 156130, 861098);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('9E-43-EA-54-0A-E7', 'BGP', 931533, 393935);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('9E-43-EA-54-0A-E7', 'DNS', 322727, 767978);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('9E-43-EA-54-0A-E7', 'HTTP', 519008, 114712);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('9E-43-EA-54-0A-E7', 'HTTPS', 997873, 660955);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('A6-B6-94-1E-07-FE', 'BGP', 16598, 460181);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('A6-B6-94-1E-07-FE', 'DHCP', 932759, 636364);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('A6-B6-94-1E-07-FE', 'DNS', 311364, 189234);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('A6-B6-94-1E-07-FE', 'HTTPS', 364181, 193177);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('A6-B6-94-1E-07-FE', 'TCP', 309463, 301272);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('BB-0B-0C-1D-24-F4', 'IMAP', 822503, 793792);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('BB-0B-0C-1D-24-F4', 'POP', 440950, 157635);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('BB-0B-0C-1D-24-F4', 'SNP', 94997, 660654);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('BB-0B-0C-1D-24-F4', 'TCP', 554635, 361496);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('E4-00-CE-46-3F-26', 'DNS', 478782, 523512);
INSERT INTO PR_DB_TEST.TRAFFIC VALUES ('E4-00-CE-46-3F-26', 'IMAP', 381783, 938555);

-- Script
WITH TOTALTRAFFIC AS (
    SELECT
        CLIENT
        , PROTOCOL
        , SUM(TRAFFIC_IN) + SUM(TRAFFIC_OUT) AS TOTAL_TRAFFIC
    FROM
        PR_DB_TEST.TRAFFIC
    GROUP BY CLIENT, PROTOCOL
)
SELECT
    CLIENT
    , GROUP_CONCAT(PROTOCOL ORDER BY TOTAL_TRAFFIC DESC) AS PROTOCOL
FROM
    TOTALTRAFFIC
GROUP BY CLIENT
ORDER BY CLIENT ASC;